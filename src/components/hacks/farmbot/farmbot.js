import { Button, Grid, ListItem, ListItemText, Typography, FormControlLabel, Checkbox, Select, Input, MenuItem, } from '@material-ui/core'
import React from 'react'
import store from '../../../store'
import { connect }from 'react-redux'
import { FixedSizeList } from 'react-window';

class Farmbot extends React.Component{
    constructor(props){
        super(props)
        this.state = {
            ores: {
                20047: {
                    ore_id: 20047,
                    ore_item_id: 50601,
                    name: 'Diamond',
                    enabled: false,
                },
                20048: {
                    ore_id: 20048,
                    ore_item_id: 50602,
                    name: 'Amber',
                    enabled: false,
                },
                20049: {
                    ore_id: 20049,
                    ore_item_id: 50603,
                    name: 'Fossil',
                    enabled: false,
                },
                20050: {
                    ore_id: 20050,
                    ore_item_id: 50604,
                    name: '__Diamond',
                    enabled: false,
                },
                20051: {
                    ore_id: 20051,
                    ore_item_id: 50605,
                    name: 'Silver',
                    enabled: false,
                },
                20052: {
                    ore_id: 20052,
                    ore_item_id: 50606,
                    name: 'Gold',
                    enabled: false,
                },
                //20053: {
                //    ore_item_id: 50606,
                //    name: 'Jadeit',
                //    enabled: false,
                //},
                20054: {
                    ore_id: 20054,
                    ore_item_id: 50608,
                    name: 'Ebonit',
                    enabled: false,
                },
                20055: {
                    ore_id: 20055,
                    ore_item_id: 50609,
                    name: 'Shells',
                    enabled: false,
                },
                20056: {
                    ore_id: 20056,
                    ore_item_id: 50610,
                    name: 'White gold',
                    enabled: false,
                },
                20057: {
                    ore_id: 20057,
                    ore_item_id: 50611,
                    name: 'Krysztal',
                    enabled: false,
                },
                20058: {
                    ore_id: 20058,
                    ore_item_id: 50612,
                    name: 'Kwarc',
                    enabled: false,
                },
                20059: {
                    ore_id: 20059,
                    ore_item_id: 50613,
                    name: 'Heavens tears',
                    enabled: false,
                },
    
            }
            
        }
    }

    onPointDelete = (index) => {   
        let _module = {
            ...this.props.hack_status.FarmBot,
            Path: this.props.hack_status.FarmBot.Path.filter((item) => item !== this.props.hack_status.FarmBot.Path[index]),
        }
        store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})

    }

    render_all_waypoints = (props) => {
        const { index, style } = props;
        return(
            <div className='waypoint'>
                <ListItem button key={index} style={style} onClick={ () => {
                    this.onPointDelete(index)
                }}>
                    <ListItemText primary={`[${index+1}] ${Math.round(this.props.hack_status.FarmBot.Path[index][0])}:${Math.round(this.props.hack_status.FarmBot.Path[index][1])}:${this.props.hack_status.FarmBot.Path[index][2]}`} />
                </ListItem> 
            </div>
            )
    }

    SwitchLookForOre = () => {
        let _module = {
            ...this.props.hack_status.FarmBot,
            LookForOre: !this.props.hack_status.FarmBot.LookForOre,
        }
        store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})
    }

    SwitchLookForMetins = () => {
        let _module = {
            ...this.props.hack_status.FarmBot,
            LookForMetins: !this.props.hack_status.FarmBot.LookForMetins,
        }
        store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})

    }

    SwitchExchangeItemsToEnergy = () => {
        let _module = {
            ...this.props.hack_status.FarmBot,
            ExchangeItemsToEnergy: !this.props.hack_status.FarmBot.ExchangeItemsToEnergy,
        }
        store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})

    }

    SwitchChangeChannel = () => {
        let _module = {
            ...this.props.hack_status.FarmBot,
            ChangeChannel: !this.props.hack_status.FarmBot.ChangeChannel,
        }
        store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})

    }

    SwitchEnabled = () => {
        let _module = {
            ...this.props.hack_status.FarmBot,
            Enabled: !this.props.hack_status.FarmBot.Enabled
        }
        store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})

    }

    OnChangeSelectOre = (ore_id) => {
        console.log(ore_id)
        let ores = this.state.ores
        let ore = this.state.ores[ore_id]
        ore.enabled = !ore.enabled
        ores[ore_id] = ore
        this.setState({ores: ores})
        if(this.props.hack_status.FarmBot.OresToMine.includes(parseInt(ore_id))){
            let _module = {
                ...this.props.hack_status.FarmBot,
                OresToMine: this.props.hack_status.FarmBot.OresToMine.filter((item) => item !== parseInt(ore_id))
            }
            store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})

        }
        else {
            let new_ores_to_mine = this.props.hack_status.FarmBot.OresToMine
            new_ores_to_mine.push(parseInt(ore_id))
            let _module = {
                ...this.props.hack_status.FarmBot,
                OresToMine: new_ores_to_mine
            }
            store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})
        }


    }

    componentDidMount = () => {
        let ores = this.state.ores
        this.props.hack_status.FarmBot.OresToMine.map((_ore_id) => {
            let ore = this.state.ores[_ore_id]
            ore.enabled = true
            ores[_ore_id] = ore
        })
        this.setState({ores: ores})  
    }

    onClearButton = () => {
        let _module = {
            ...this.props.hack_status.FarmBot,
            Path: [],
        }
        store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})
   
    }
    onChangeWaitingTime = (new_value) => {
        let _module = {
            ...this.props.hack_status.FarmBot,
        WaitingTime: new_value
        }
        store.dispatch({type: 'UPDATE_ONE_HACK_MODULE', client: this.props.socket, payload: { module_dict:_module, module_name: 'FarmBot'}, index:store.getState().receivePacketesReducer.selected_client_id})
    }

    render = () => {
        return (

            <Grid container>
                <Grid item xs={12}>
                    <Typography> Waypoints </Typography> 
                    <Typography className='small-going-to-point'> Going to point {this.props.hack_status.FarmBot.CurrentWaypointIndex+1} </Typography> 
                    <FixedSizeList height={200} width={'100%'} itemSize={46} itemCount={this.props.hack_status.FarmBot.Path.length}>
                        {this.render_all_waypoints}
                    </FixedSizeList>
                    <Button onClick={() => this.onClearButton} primary> Clear path </Button>
                    <Grid item>
                            <Grid>
                                <Grid>
                                    <FormControlLabel control={<Checkbox checked={this.props.hack_status.FarmBot.Enabled} onChange={ () => this.SwitchEnabled()} name="mine"/>} label="Start"/>
                                </Grid> 
                                <Grid>
                                    <FormControlLabel control={<Checkbox checked={this.props.hack_status.FarmBot.LookForOre} onChange={ () => this.SwitchLookForOre()} name="mine"/>} label="Look for ores"/>
                                    <FormControlLabel control={<Checkbox checked={this.props.hack_status.FarmBot.LookForMetins} onChange={ () => this.SwitchLookForMetins()} name="mine"/>} label="Look for metins"/>
                                    <FormControlLabel control={<Checkbox checked={this.props.hack_status.FarmBot.ExchangeItemsToEnergy} onChange={ () => this.SwitchExchangeItemsToEnergy()} name="mine"/>} label="ExchangeItemsToEnergy"/>
                                    <FormControlLabel control={<Checkbox checked={this.props.hack_status.FarmBot.ChangeChannel} onChange={ () => this.SwitchChangeChannel()} name="mine"/>} label="ChangeChannel"/>
                                    <Input type='number' value={this.props.hack_status.FarmBot.WaitingTime} onChange={(e)=>this.onChangeWaitingTime(parseInt(e.target.value))}/>
                                </Grid>
                                <Grid>
                                <Select
                                    multiple
                                    value={Object.entries(this.state.ores).map( ([key, _value]) => {return _value.name})}
                                    input={<Input />}
                                    renderValue={(selected) => 'Ores to mine'}
                                    >
                                    {Object.entries(this.state.ores).map( ([key, _value]) => {
                                        //console.log(key, _value)
                                        //onChange={(e) => this.OnChangeSelectOre(e.target.value)}
                                        return (
                                            <MenuItem key={key} value={key}>
                                                <Checkbox checked={_value.enabled} value={key} onChange={(e)=>this.OnChangeSelectOre(parseInt(e.target.value))}/> 
                                            <ListItemText primary={_value.name.toString()} />
                                            </MenuItem>
                                        )
                                    })}
                                    </Select>
                                </Grid>   
                                <Grid>
                                </Grid>   
                                <Grid>
                                </Grid>   
  
                            </Grid>
                            <Grid>

                            </Grid>

                    </Grid>
                </Grid>
            </Grid>
        )
    }
}

function mapStateToProps(state){
    //console.log(state.receivePacketesReducer.character_status)
    return {
        hack_status: state.receivePacketesReducer.hack_status
    }
}

export default connect(mapStateToProps)(Farmbot)