import React from 'react'
import store from '../../store'
import { FixedSizeList } from 'react-window'
import { Grid, ListItem, Typography, FormControlLabel} from '@material-ui/core'
import { HackbarCheckbox, HackbarTextField } from '../hackbar_style/hackbar_style.js'
import { shouldComponentUpdate } from "react-window";
import './pickup_filter.css'
import { ACTIONS } from '../../utils/enums.js'
import FileHandler from "./file_handler";

class PickupFilter extends React.Component {
    constructor(props){
        super(props)
        this.state = {
            show_only_checked: false,
            show_only_unchecked: false,
            item_filter: '',
            items_to_show: [],
            interval: setInterval(() => {
                this.refreshPickupFilter()
              }, 500),
        }
        this.shouldComponentUpdate = shouldComponentUpdate.bind(this)
    }

    componentDidMount = () => {
        this.refreshPickupFilter()
    }
    componentWillUnmount = () => {
        clearInterval(this.state.interval);
    }

    refreshPickupFilter = () => {
        let index = store.getState().receivePacketsReducer.selected_client_id
        store.dispatch({type: ACTIONS.GET_PICKUP_FILTER, client: this.props.socket, index: index})
        this.onReceivePickupFilter()

    }

    render_item_filter = (props) => {

        const { index, style } = props;
        let item = this.props.item_list[this.state.items_to_show[index]]
        let checked = false
        if(this.props.pickup_filter.includes( parseInt(this.state.items_to_show[index]))){
            checked = true
        }
        //console.log(this.props.icon_names[this.state.items_to_show[index]])
        return(
            <div className='item'>
                <ListItem button key={index} style={style}>
                    <img src={'https://metin2cms.cf/items/img/icons/' + this.props.icon_names[this.state.items_to_show[index]].name + '.png'} />
                    <FormControlLabel control={<HackbarCheckbox checked={checked} onChange={ () => {this.onChangeItemPickup(this.state.items_to_show[index])}} name="mine"/>} label={item.name} />
                </ListItem> 
            </div>
            )
    }
 
    onChangeItemPickup = (item_id) => {
        if(this.props.pickup_filter.includes(item_id)){
            let _module = {
                pickup_filter: this.props.pickup_filter.filter((item) => item !== item_id)
            }
            store.dispatch({type: ACTIONS.UPDATE_ONE_HACK_MODULE, client: this.props.socket, payload: { module_dict:_module, module_name: 'PickupFilter'}, index:store.getState().receivePacketsReducer.selected_client_id})
            this.forceUpdate()
        }
        else{
            let new_pickup_filter = this.props.pickup_filter
            new_pickup_filter.push(item_id)
            let _module = {
                pickup_filter: new_pickup_filter
            }
            store.dispatch({type: ACTIONS.UPDATE_ONE_HACK_MODULE, client: this.props.socket, payload: { module_dict:_module, module_name: 'PickupFilter'}, index:store.getState().receivePacketsReducer.selected_client_id})      
            this.forceUpdate()
        }

    }

    switchShowOnlyChecked = () => {
        this.setState({
            ...this.state,
            show_only_checked: !this.state.show_only_checked,
            show_only_unchecked: false,
        })
    }

    switchShowOnlyUnchecked = () => {
        this.setState({
            ...this.state,
            show_only_checked: false,
            show_only_unchecked: !this.state.show_only_unchecked,
        })
    }

    onPickupFilterChange = (event) =>{
        
        this.setState({
            ...this.state,
            item_filter: event.target.value
        })
    }

    onReceivePickupFilter = () => {

        if(this.props.pickup_filter){
            let items_to_show = []
            if(this.state.show_only_checked){
                Object.keys(this.props.item_list).map(item => {
                    if(this.props.pickup_filter.includes(parseInt(item))){
                        if(this.props.item_list[item].name.includes(this.state.item_filter)){
                            items_to_show.push(parseInt(item))
                        }
                    }
                })
                this.setState({
                    ...this.state,
                    items_to_show: items_to_show
                })
                return
            }
            else if(this.state.show_only_unchecked){
                Object.keys(this.props.item_list).map(item => {
                    if(!this.props.pickup_filter.includes(parseInt(item))){
                        if(this.props.item_list[item].name.includes(this.state.item_filter)){
                            items_to_show.push(parseInt(item))
                        }
                    }
                })
                this.setState({
                    ...this.state,
                    items_to_show: items_to_show
                })
                return
            }
            else{
                Object.keys(this.props.item_list).map(item => {
                    if(this.props.item_list[item].name.includes(this.state.item_filter)){
                        items_to_show.push(parseInt(item))
                    }
                })
                this.setState({
                    ...this.state,
                    items_to_show: items_to_show
                })
            }
        }


    }

    render = () => {
        let input_label_text = this.props.language.label_item_filter
        let label_item_filter_helper = this.props.language.label_item_filter_helper
        return (
            <>
            <Grid item xs={12} className='pickup-filter-header'>
                <Typography> {this.props.language.pickup_list} </Typography>
            </Grid>
            <Grid item xs={6}>
            <FormControlLabel control={<HackbarCheckbox checked={this.state.show_only_checked} onChange={ () => {this.switchShowOnlyChecked()}} name="mine"/>} label={this.props.language.show_only_checked} />
            </Grid>
            <Grid item xs={6}>
            <FormControlLabel control={<HackbarCheckbox checked={this.state.show_only_unchecked} onChange={ () => {this.switchShowOnlyUnchecked()}} name="mine"/>} label={this.props.language.show_only_unchecked} />
            </Grid>
            <Grid item xs={12}>
                <HackbarTextField helperText={label_item_filter_helper} label={input_label_text} type='text' onKeyDown={e => e.stopPropagation()}
                 onChange={this.onPickupFilterChange} value ={this.state.item_filter} defaultValue={this.state.item_filter}
                 fullWidth={true} margin={'dense'}/>
            </Grid>
            <Grid item xs={12}>
                <FixedSizeList height={200} width={'100%'} itemSize={40} itemCount={this.state.items_to_show.length} onChange={() => this.shouldComponentUpdate()}>
                    {this.render_item_filter}
                </FixedSizeList>
            </Grid>
                <Grid item xs={12}>
                    <FileHandler socket={this.props.socket} pickup_filter language={this.props.file_handler_language}/>
                </Grid>
            </>
        )
    }
}

export default PickupFilter





